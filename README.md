
# CrioÂ AI Audit Agent

AI Audit Agent for outbound Blandâ€‘AI calls to check for **hallucinations, promptâ€‘drift and QA (SHAPE) policy
violations**, then log structured results back to Google Sheets.

* **Stack** â€“ NodeÂ 18Â +, Google Sheets API, Google Drive API, GeminiÂ 2â€‘Flash, Blandâ€‘AI, Winston logging  
* **Modes** â€“  
  * **Batch CLI** (`npm start`) sweeps the â€œpendingâ€ rows in the sheet  
  * **REST API** (`npm run api`) offers onâ€‘demand call audits & sheet sweeps  
  * **Utility** (`npm run genkey`) rotates a 256â€‘bit API key and rewrites `.env`  
* **Selfâ€‘healing Driveâ€‘cache** rebuilds every 24Â hours when the queue is idle  
* **Zeroâ€‘downtime** â€“ audits run in an inâ€‘memory FIFO queue; the API responds `202Â Accepted` immediately

---

## 1Â Â Repository Layout

```text
.
â”œâ”€ src/
â”‚  â”œâ”€ auth.js               â† Google auth singleton
â”‚  â”œâ”€ bland.js              â† fetchTranscript() helper
â”‚  â”œâ”€ driveCache.js         â† recursive Drive index + text cache
â”‚  â”œâ”€ gemini.js             â† functionâ€‘calling wrapper (verbose ğŸªµ)
â”‚  â”œâ”€ sheets.js             â† pendingRows / markSuccess / upsertRow
â”‚  â”œâ”€ index.js              â† batch CLI + exported auditOneCall()
â”‚  â”œâ”€ server.js             â† nonâ€‘blocking REST API + 24Â h cache refresh
â”‚  â””â”€ utils/
â”‚     â””â”€ logger.js          â† Winston config
â”‚
â”œâ”€ config/
â”‚  â””â”€ Audit_Agent_Prompt.json  â† base structured prompt for Gemini
â”‚
â”œâ”€ scripts/
â”‚  â””â”€ genKey.js              â† generates 256â€‘bit AUDIT_API_KEY (--force)
â”‚
â”œâ”€ .env.example              â† template of all env vars
â””â”€ package.json
```

---

## 2Â Â Quickâ€‘start

```bash
git clone <repo>
cd crio-ai-audit-agent
cp .env.example .env      # fill in secrets
npm ci

# generate first API key
npm run genkey            # or: npm run genkey -- --force

# oneâ€‘shot batch sweep
npm start

# start REST microâ€‘service
npm run api
```

---

## 3Â Â Environment Variables (`.env`)

| Variable | Example | Required | Notes |
|----------|---------|----------|-------|
| `GOOGLE_SHEETS_ID`        | `1BxiM...` | âœ… | Audit Sheet ID |
| `DRIVE_ROOT_FOLDER_ID`    | `1HXC...`  | âœ… | Root containing KB / Prompt / SHAPE |
| `BLAND_API_KEY`           | `sk_live_â€¦`| âœ… | BlandÂ AI access |
| `GEMINI_API_KEY`          | `AIza...`  | âœ… | GeminiÂ 2â€‘Flash access |
| `AUDIT_SHEET_NAME`        | `Crio_AI_Audit_Log` | â€“ | Sheet tab |
| `PROMPT_PARENT_DIR`       | `Prompt/General`    | â€“ | Prompt folder |
| `KNOWLEDGE_BASE_ROOT`     | `Knowledge_Base`    | â€“ | KB path prefix |
| `AUDIT_API_KEY`           | _64â€‘hex_            | ğŸ”„ | Rotated by `npm run genkey` |
| `PORT`                    | `3000`              | â€“ | REST port |

---

## 4Â Â Drive Cache

* `driveCache.init(rootId)` recursively indexes **all** `.txt` under the root and
  stores raw content keyed by Drive path.  
* `server.js` schedules a rebuild every 24Â hours (`REFRESH_MS`). If audits are
  running (`working || queue.length`), refresh defers 5â€¯min.

---

## 5Â Â CLIÂ â€“ Batch Sweep (`npm start`)

1. Load cache (or use refreshed cache)  
2. Read rows where **AuditÂ Status â‰  â€œSuccessfulâ€**  
3. For each row:  
   * Fetch Bland transcript  
   * Call Gemini with metadata only â€“ Gemini pulls files via `get_drive_txt()`  
   * Write columns **H â€¦â€¯M** and set **G â†’ Successful**

ColumnÂ M stores the full Gemini JSON blob for BI reuse.

---

## 6Â Â RESTÂ API

| Verb | Path | Body | Description |
|------|------|------|-------------|
| **POST** | `/api/audit/call/:id` | `{ "promptFile":"prompt_v1.0.txt", ... }` | Enqueue audit of one call. Metadata required only if row absent. |
| **POST** | `/api/audit/sheet` | â€“ | Enqueue sheet sweep. If already running, returns `queued:false`. |
| **GET** | `/api/health` | â€“ | Returns `OK`. |

*Responses*Â â€“ `202Â Accepted` when queued; `200Â OK` with message for duplicate sweep.

---

## 7Â Â Security

* Header `x-api-key: $AUDIT_API_KEY` (256â€‘bit, generated by `genKey.js`).  
* Helmet + rateâ€‘limit (30â€¯req/min/IP).  
* All secrets in `.env`.

---

## 8Â Â Logging

* Winston, JSON or colored console.  
* `LOG_LEVEL=debug` shows: payload size, KB path counts, tool calls, transcript length.

---

## 9Â Â Extending

* Swap in Redis/SQS for distributed queue.  
* Schedule `/api/audit/sheet` via Cloud Scheduler.  
* Prometheus counters in `handleSingle` / `handleSweep`.

---

## 10Â Â Troubleshooting

| Symptom | Cause | Fix |
|---------|-------|-----|
| Empty arrays written | Transcript <â€¯10Â chars | Verify Bland path, look at `ğŸªµ transcript length` |
| Gemini 400 â€œsystem role not supportedâ€ | Wrong field | Ensure request uses `system_instruction` |
| Cache never refreshes | Constant audits | Lower `REFRESH_MS` or add more server instances |

---