
# Crio AI Audit Agent

AI Audit Agent for outbound Bland‑AI calls to check for **hallucinations, prompt‑drift and QA (SHAPE) policy
violations**, then log structured results back to Google Sheets.

* **Stack** – Node 18 +, Google Sheets API, Google Drive API, Gemini 2‑Flash, Bland‑AI, Winston logging  
* **Modes** –  
  * **Batch CLI** (`npm start`) sweeps the “pending” rows in the sheet  
  * **REST API** (`npm run api`) offers on‑demand call audits & sheet sweeps  
  * **Utility** (`npm run genkey`) rotates a 256‑bit API key and rewrites `.env`  
* **Self‑healing Drive‑cache** rebuilds every 24 hours when the queue is idle  
* **Zero‑downtime** – audits run in an in‑memory FIFO queue; the API responds `202 Accepted` immediately

---

## 1  Repository Layout

```text
.
├─ src/
│  ├─ auth.js               ← Google auth singleton
│  ├─ bland.js              ← fetchTranscript() helper
│  ├─ driveCache.js         ← recursive Drive index + text cache
│  ├─ gemini.js             ← function‑calling wrapper (verbose 🪵)
│  ├─ sheets.js             ← pendingRows / markSuccess / upsertRow
│  ├─ index.js              ← batch CLI + exported auditOneCall()
│  ├─ server.js             ← non‑blocking REST API + 24 h cache refresh
│  └─ utils/
│     └─ logger.js          ← Winston config
│
├─ config/
│  └─ Audit_Agent_Prompt.json  ← base structured prompt for Gemini
│
├─ scripts/
│  └─ genKey.js              ← generates 256‑bit AUDIT_API_KEY (--force)
│
├─ .env.example              ← template of all env vars
└─ package.json
```

---

## 2  Quick‑start

```bash
git clone <repo>
cd crio-ai-audit-agent
cp .env.example .env      # fill in secrets
npm ci

# generate first API key
npm run genkey            # or: npm run genkey -- --force

# one‑shot batch sweep
npm start

# start REST micro‑service
npm run api
```

---

## 3  Environment Variables (`.env`)

| Variable | Example | Required | Notes |
|----------|---------|----------|-------|
| `GOOGLE_SHEETS_ID`        | `1BxiM...` | ✅ | Audit Sheet ID |
| `DRIVE_ROOT_FOLDER_ID`    | `1HXC...`  | ✅ | Root containing KB / Prompt / SHAPE |
| `BLAND_API_KEY`           | `sk_live_…`| ✅ | Bland AI access |
| `GEMINI_API_KEY`          | `AIza...`  | ✅ | Gemini 2‑Flash access |
| `AUDIT_SHEET_NAME`        | `Crio_AI_Audit_Log` | – | Sheet tab |
| `PROMPT_PARENT_DIR`       | `Prompt/General`    | – | Prompt folder |
| `KNOWLEDGE_BASE_ROOT`     | `Knowledge_Base`    | – | KB path prefix |
| `AUDIT_API_KEY`           | _64‑hex_            | 🔄 | Rotated by `npm run genkey` |
| `PORT`                    | `3000`              | – | REST port |

---

## 4  Drive Cache

* `driveCache.init(rootId)` recursively indexes **all** `.txt` under the root and
  stores raw content keyed by Drive path.  
* `server.js` schedules a rebuild every 24 hours (`REFRESH_MS`). If audits are
  running (`working || queue.length`), refresh defers 5 min.

---

## 5  CLI – Batch Sweep (`npm start`)

1. Load cache (or use refreshed cache)  
2. Read rows where **Audit Status ≠ “Successful”**  
3. For each row:  
   * Fetch Bland transcript  
   * Call Gemini with metadata only – Gemini pulls files via `get_drive_txt()`  
   * Write columns **H … M** and set **G → Successful**

Column M stores the full Gemini JSON blob for BI reuse.

---

## 6  REST API

| Verb | Path | Body | Description |
|------|------|------|-------------|
| **POST** | `/api/audit/call/:id` | `{ "promptFile":"prompt_v1.0.txt", ... }` | Enqueue audit of one call. Metadata required only if row absent. |
| **POST** | `/api/audit/sheet` | – | Enqueue sheet sweep. If already running, returns `queued:false`. |
| **GET** | `/api/health` | – | Returns `OK`. |

*Responses* – `202 Accepted` when queued; `200 OK` with message for duplicate sweep.

---

## 7  Security

* Header `x-api-key: $AUDIT_API_KEY` (256‑bit, generated by `genKey.js`).  
* Helmet + rate‑limit (30 req/min/IP).  
* All secrets in `.env`.

---

## 8  Logging

* Winston, JSON or colored console.  
* `LOG_LEVEL=debug` shows: payload size, KB path counts, tool calls, transcript length.

---

## 9  Extending

* Swap in Redis/SQS for distributed queue.  
* Schedule `/api/audit/sheet` via Cloud Scheduler.  
* Prometheus counters in `handleSingle` / `handleSweep`.

---

## 10  Troubleshooting

| Symptom | Cause | Fix |
|---------|-------|-----|
| Empty arrays written | Transcript < 10 chars | Verify Bland path, look at `🪵 transcript length` |
| Gemini 400 “system role not supported” | Wrong field | Ensure request uses `system_instruction` |
| Cache never refreshes | Constant audits | Lower `REFRESH_MS` or add more server instances |

---